/*Consulta no banco de dados para trazer a relação dos usuários ativos associados, vinculados as unidades/setores
da Secretária Municipal da Educação de Ribeirão Preto*/
SELECT A.CDUSUARIO, U.NMUSUARIO, B.SGORGAOSETOR, A.FLSETORDEFAULT
FROM SOLAR.ESEGUSRSETORSIST A
JOIN SOLAR.ECPAORGAOSETOR B ON A.CDORGAOSETOR = B.CDORGAOSETOR
JOIN SOLAR.ESEGUSUARIO U ON A.CDUSUARIO = U.CDUSUARIO
WHERE A.CDSISTEMA = 64
AND (B.SGORGAOSETOR LIKE '%EDUC%' OR B.SGORGAOSETOR LIKE '%DIR%')
AND B.FLSETORATIVO = 'S'
ORDER BY A.CDUSUARIO;

/*Consulta no banco de dados para trazer a relação dos usuários ativos associados, vinculados as unidades/setores
da Secretária Municipal da Assistência Social de Ribeirão Preto*/
SELECT A.CDUSUARIO AS Usuário, 
       INITCAP(U.NMUSUARIO) AS Nome_do_Usuário, 
       B.SGORGAOSETOR AS Sigla_da_Unidade_Setor, 
       CASE WHEN A.FLSETORDEFAULT = 'S' THEN 'Sim'
            WHEN A.FLSETORDEFAULT = 'N' THEN 'Não'
            ELSE A.FLSETORDEFAULT 
       END AS Unidade_Setor_Padrão
FROM SOLAR.ESEGUSRSETORSIST A
JOIN SOLAR.ECPAORGAOSETOR B ON A.CDORGAOSETOR = B.CDORGAOSETOR
JOIN SOLAR.ESEGUSUARIO U ON A.CDUSUARIO = U.CDUSUARIO
WHERE A.CDSISTEMA = 64
AND (B.SGORGAOSETOR LIKE '%SEMAS%' OR B.SGORGAOSETOR LIKE '%FRASSOL%' OR B.SGORGAOSETOR LIKE '%PAEFI%' OR B.SGORGAOSETOR LIKE '%MJM%')
AND B.FLSETORATIVO = 'S'
ORDER BY U.NMUSUARIO;

/*Consulta no banco de dados para trazer a relação das unidades/setores do usuário informado*/
SELECT
    A.CDUSUARIO AS Usuário,
    U.NMUSUARIO AS Nome_do_Usuário,
    B.SGORGAOSETOR AS Sigla_da_Unidade_Setor,
    B.NMORGAOSETOR AS Nome_da_Unidade_Setor,
    A.FLSETORDEFAULT AS Unidade_Setor_Padrão
FROM SOLAR.ESEGUSRSETORSIST A
JOIN SOLAR.ECPAORGAOSETOR B ON A.CDORGAOSETOR = B.CDORGAOSETOR
JOIN SOLAR.ESEGUSUARIO U ON A.CDUSUARIO = U.CDUSUARIO
WHERE A.CDSISTEMA = 64
AND A.CDUSUARIO = '36460043809' --ERICK MARZOLA BRESCIANI--
ORDER BY CASE 
            WHEN A.FLSETORDEFAULT = 'S' THEN 1 
            ELSE 2 
         END, 
         B.SGORGAOSETOR;

/*Consulta no banco de dados para trazer a relação das unidades/setores dos usuários informados*/
SELECT
    A.CDUSUARIO AS Usuário,
    U.NMUSUARIO AS Nome_do_Usuário,
    B.SGORGAOSETOR AS Sigla_da_Unidade_Setor,
    B.NMORGAOSETOR AS Nome_da_Unidade_Setor,
    A.FLSETORDEFAULT AS Unidade_Setor_Padrão
FROM SOLAR.ESEGUSRSETORSIST A
JOIN SOLAR.ECPAORGAOSETOR B ON A.CDORGAOSETOR = B.CDORGAOSETOR
JOIN SOLAR.ESEGUSUARIO U ON A.CDUSUARIO = U.CDUSUARIO
WHERE A.CDSISTEMA = 64
AND A.CDUSUARIO IN ('08311233896','03826151828','08706230873','02040330801','05615008865','04956531877','00543393836','14366966824','10903566842','10176837434','07169722801','32952242852','41926198816','40584056869','33213552801','35842603888','94792275849','36561600827','23567998854','36465833808','42630362809','31230848843','22856813801','05690075850','15847451857','07170720884','18452471831','20054331870','22859071687','00580409600','11828913812','60520370830','01123849196','38554774850','36942433802','04148534159','25635264859','36402237809','07306985990','22137204878','07133809850','06602663852','33517753858','34852510890','07597154674','00889170967','21850503893','36740366810','17861618854','42701375843','25437512899','42218307863','36662545864','41876430877','35340368831','33494842809','35411798809','07103396825','18137072861','03438987805','32088198890','35944526890','36657642890','37596048897','44491475881','44982682615','35258494861','09481262804','39321965890','21665647809','02643885856','35267785822','36933423859','35275646836','10912031808','38709827803','07136818885','11387239830','60463155653','46347070715','55107192815','04609965844','31460709870','36382716847','60463155653','39593667873','56941781734','75559048615','02000919804','97422290820','07529411861','73450545604','21582595828','17546857813','18324283897','30781727839','21768299803','09412800800','35971841890','36879121837','01548457876','14446257803','86284312849','04833339803','10700255850','05326751852','07782827671','13857756888','86900005772','10912654880','14456040866','06261393842','93231601800','00541159810','13856519890','13856519890','21613691807','29598000877','04756888569','45527190840','10868401862','28569905840','35638050833','02663078840','05246934802','14104043826','46963450846','31855183811','79206298534','31182235883','74531492820','07156033883','38871432568','07154492813','14111867880','44897465800','06674170950','10896932818','35750753875','10343422824','07164358885','48498750687','48498750687','74810316815','11737837846','28545672691','02836348801','21936999846','06265862839','02024827829','13723876846','02171033835','10931948800','02051013802','02997824842','05028521867','25437512899','30416688829','39044948806','26656433839','27381174812','53237102768','02012187803','05239187800','07149613888','05888836893','04515246836','07145368811','12219650855','27662563855','61180130120','28668858807','45842208830','49007149687','14958121897','07145269830','15971189824','41579687865','26047990819','36829628830','11444898655','40707328888','14455980865','04185612818','07171894819','02026524831','18322551827','14108420888','41575450879','06256747828','34881226894','40490118836','44379377830','33652563859','08139783862','86300377849','12225154821','04501492856','09878452840','05385481858','16175157877','30690927649','27516145823','45253383859','03718965178','37032408818','26824647691','17546882842','07171322858','45646040663')
ORDER BY U.NMUSUARIO,
         CASE 
            WHEN A.FLSETORDEFAULT = 'S' THEN 1 
            ELSE 2 
         END, 
         B.SGORGAOSETOR;

--Consulta no banco de dados para trazer a relação dos usuários ativos, associados a um determinado endereço de e-mail--
SELECT * FROM ESEGUSUARIO e 
    WHERE e.DEEMAIL = 'thiago.teixeira@softplan.com.br'

--Consulta no banco de dados para trazer a relação dos usuários ativos--
SELECT CDUSUARIO, NMUSUARIO, DTATIVACAO, TPUSUARIO, NUCPFCNPJ, FLHABILITADO, DEEMAIL, DTULTLOGINOK, TPPESSOA
FROM SOLAR.ESEGUSUARIO WHERE FLHABILITADO = 'S' ORDER BY NMUSUARIO;

--Relatório de Envio Mensal do Renato--
--Busca o total de usuários ativos (sem duplicidade) em setores ativos, desconsiderando o portal externo ("PORTAL" (PORTAL)), buscando por orgao e somando o total de usuários do portal interno--

--select para garantir que não está trazendo o mesmo usuário mais de uma vez
SELECT DISTINCT
    A.CDUSUARIO AS USUARIO,
    U.NMUSUARIO AS NOME_DO_USUARIO
FROM 
    SOLAR.ESEGUSRSETORSIST A
    INNER JOIN SOLAR.ECPAORGAOSETOR B ON A.CDORGAOSETOR = B.CDORGAOSETOR
    INNER JOIN SOLAR.ESEGUSUARIO U ON A.CDUSUARIO = U.CDUSUARIO
WHERE 
    A.CDSISTEMA = 64
    AND B.FLSETORATIVO = 'S'
    AND U.FLHABILITADO = 'S'
    AND B.CDORGAOSETOR != 18 -- 18 portal
    AND B.CDORGAO = 1 -- PMRP
ORDER BY 
    A.CDUSUARIO;

-- select para contar a quantidade de usuários , após validar o select de cima 
SELECT
    COUNT(DISTINCT A.CDUSUARIO) AS TOTAL_USUARIOS_ATIVOS
FROM 
    SOLAR.ESEGUSRSETORSIST A
    INNER JOIN SOLAR.ECPAORGAOSETOR B ON A.CDORGAOSETOR = B.CDORGAOSETOR
    INNER JOIN SOLAR.ESEGUSUARIO U ON A.CDUSUARIO = U.CDUSUARIO
WHERE 
    A.CDSISTEMA = 64
    AND B.FLSETORATIVO = 'S'
    AND U.FLHABILITADO = 'S'
    AND B.CDORGAOSETOR != 18 -- 18 portal  deixar '=' se quiser pegar os usuários externos, e deixar '!=' se quiser pegar os usuários internos
    AND B.CDORGAO = 1; -- PMRP 

--Busca todos os usuários ativos em setores ativos, retirando portal e buscando por orgao--
SELECT 
    A.CDUSUARIO, 
    U.NMUSUARIO, 
    B.SGORGAOSETOR, 
    B.NMORGAOSETOR ,
    B.FLSETORATIVO ,
    A.FLSETORDEFAULT
FROM 
    SOLAR.ESEGUSRSETORSIST A
    INNER JOIN SOLAR.ECPAORGAOSETOR B ON A.CDORGAOSETOR = B.CDORGAOSETOR
    INNER JOIN SOLAR.ESEGUSUARIO U ON A.CDUSUARIO = U.CDUSUARIO
WHERE 
    A.CDSISTEMA = 64
    AND B.FLSETORATIVO = 'S'
    AND U.FLHABILITADO = 'S'
    AND B.CDORGAOSETOR != 18 -- 18 portal
    AND B.CDORGAO = 1 -- PMRP
ORDER BY 
    A.CDUSUARIO;

--Busca todos os usuários ativos (sem duplicidade) em setores ativos, retirando portal e buscando por orgao--
SELECT 
    COUNT(DISTINCT A.CDUSUARIO) AS TOTAL_USUARIOS_ATIVOS
FROM 
    SOLAR.ESEGUSRSETORSIST A
    INNER JOIN SOLAR.ECPAORGAOSETOR B ON A.CDORGAOSETOR = B.CDORGAOSETOR
    INNER JOIN SOLAR.ESEGUSUARIO U ON A.CDUSUARIO = U.CDUSUARIO
WHERE 
    A.CDSISTEMA = 64
    AND B.FLSETORATIVO = 'S'
    AND U.FLHABILITADO = 'S'
    AND B.CDORGAOSETOR != 18
    AND B.CDORGAO = 1 -- PMRP

--Busca todos os usuários ativos (sem duplicidade) no setor "PORTAL" (PORTAL) e buscando por orgao--
SELECT 
    COUNT(DISTINCT A.CDUSUARIO) AS TOTAL_USUARIOS_ATIVOS
FROM 
    SOLAR.ESEGUSRSETORSIST A
    INNER JOIN SOLAR.ECPAORGAOSETOR B ON A.CDORGAOSETOR = B.CDORGAOSETOR
    INNER JOIN SOLAR.ESEGUSUARIO U ON A.CDUSUARIO = U.CDUSUARIO
WHERE 
    A.CDSISTEMA = 64
    AND B.FLSETORATIVO = 'S'
    AND U.FLHABILITADO = 'S'
    AND B.CDORGAOSETOR = 18 -- 18 portal
    AND B.CDORGAO = 1 -- PMRP

--Busca o total de usuários ativos (sem duplicidade) em setores ativos, separando o total de usuários do portal interno e portal externo ("PORTAL" (PORTAL)), buscando por orgao e somando o total de usuários do portal interno + portal externo--
SELECT 
    COUNT(DISTINCT CASE WHEN B.CDORGAOSETOR != 18 THEN A.CDUSUARIO END) AS TOTAL_DE_USUARIOS_ATIVOS_DO_PORTAL_INTERNO,
    COUNT(DISTINCT CASE WHEN B.CDORGAOSETOR = 18 THEN A.CDUSUARIO END) AS TOTAL_DE_USUARIOS_ATIVOS_DO_PORTAL_EXTERNO,
    COUNT(DISTINCT CASE WHEN B.CDORGAOSETOR != 18 THEN A.CDUSUARIO END) + 
    COUNT(DISTINCT CASE WHEN B.CDORGAOSETOR = 18 THEN A.CDUSUARIO END) AS TOTAL_GERAL
FROM 
    SOLAR.ESEGUSRSETORSIST A
    INNER JOIN SOLAR.ECPAORGAOSETOR B ON A.CDORGAOSETOR = B.CDORGAOSETOR
    INNER JOIN SOLAR.ESEGUSUARIO U ON A.CDUSUARIO = U.CDUSUARIO
WHERE 
    A.CDSISTEMA = 64
    AND B.FLSETORATIVO = 'S'
    AND U.FLHABILITADO = 'S'
    AND B.CDORGAO = 1 -- PMRP

--Busca todos os usuários ativos nos setores indicados e buscando por orgao--
SELECT 
    U.CDUSUARIO AS USUARIO,
    U.NMUSUARIO AS NOME_DO_USUARIO,
    B.SGORGAOSETOR AS SIGLA_SETOR,
    B.NMORGAOSETOR AS NOME_SETOR
FROM 
    SOLAR.ESEGUSRSETORSIST A
    INNER JOIN SOLAR.ECPAORGAOSETOR B ON A.CDORGAOSETOR = B.CDORGAOSETOR
    INNER JOIN SOLAR.ESEGUSUARIO U ON A.CDUSUARIO = U.CDUSUARIO
WHERE 
    A.CDSISTEMA = 64
    AND B.FLSETORATIVO = 'S'
    AND U.FLHABILITADO = 'S'
    AND B.CDORGAOSETOR IN (
    	501, -- 501 FAZ-11
    	514, -- 514 FAZ-11 CP
    	502, -- 502 FAZ-11 CIP
    	508, -- 508 FAZ-13
    	509, -- 509 FAZ-13 COM
    	2238, -- 2.238 FAZ-13 DECI
    	510, -- 510 FAZ-13 NOT
    	504, -- 504 FAZ-14
    	2324, -- 2.324 FAZ-14 AVB
    	2400, -- 2.400 FAZ-14 COM
    	1941, -- 1.941 FAZ-14 CART
    	1939, -- 1.939 FAZ-14 NOT
    	1940, -- 1.940 FAZ-14 VISTAS
    	505, -- 505 FAZ-16
    	506, -- 506 FAZ-16 COM
    	507, -- 507 FAZ-16 NOT
    	547, -- 547 FAZ-21
    	550, -- 550 FAZ-21 DIR
    	537, -- 537 FAZ-22
    	538, -- 538 FAZ 22 MF
    	540, -- 540 FAZ-23
    	541, -- 541 FAZ-23 COM
    	542, -- 542 FAZ-23 CER
    	2517, -- 2.517 FAZ-23 ISS
    	544, -- 544 FAZ-24
    	2076, -- 2.076 FAZ-24 FISCAL
    	3252, -- 3.252 FAZ-24 TAXAS
    	543, -- 543 FAZ-25
    	3322, -- 3.322 FAZ-25 DEM
    	3304, -- 3.304 FAZ-25 DEV
    	2075 -- 2.075 FAZ-25 FISCAL
    	)
    AND B.CDORGAO = 1 -- PMRP
    ORDER BY B.SGORGAOSETOR ASC

--Busca todos os usuários (usuário e nome do usuário) ativos nos setores indicados e buscando por orgao--
SELECT
	ESPAI.SGORGAOSETOR AS SIGLA_SETOR_PAI, 
    ESPAI.NMORGAOSETOR AS NOME_SETOR_PAI,
    ES.SGORGAOSETOR AS SIGLA_SETOR,
    ES.NMORGAOSETOR AS NOME_SETOR,
    U.CDUSUARIO AS USUARIO,
    U.NMUSUARIO AS NOME_DO_USUARIO
FROM 
    SOLAR.ECPAORGAOSETOR ES
LEFT JOIN 
    SOLAR.ECPAORGAOSETOR ESPAI ON ES.CDSETORPAI = ESPAI.CDORGAOSETOR
INNER JOIN 
    SOLAR.ESEGUSRSETORSIST A ON ES.CDORGAOSETOR = A.CDORGAOSETOR
INNER JOIN 
    SOLAR.ESEGUSUARIO U ON A.CDUSUARIO = U.CDUSUARIO
WHERE 
    ES.CDORGAO = (SELECT CDORGAOSETOR FROM SOLAR.ECPAORGAOSETOR WHERE SGORGAOSETOR = 'PMRP')
    AND ES.FLSETORATIVO = 'S'
    AND A.CDSISTEMA = 64
    AND U.FLHABILITADO = 'S'
    AND ES.SGORGAOSETOR IN (
    	'FAZ-11',
    	'FAZ-11 CIP',
    	'FAZ-11 CP',
    	'FAZ-13',
    	'FAZ-13 COM',
    	'FAZ-13 DECI',
    	'FAZ-13 NOT',
    	'FAZ-14',
    	'FAZ-14 AVB',
    	'FAZ-14 CART',
    	'FAZ-14 COM',
    	'FAZ-14 NOT',
    	'FAZ-14 VISTAS',
    	'FAZ-16',
    	'FAZ-16 COM',
    	'FAZ-16 NOT',
    	'FAZ-21',
    	'FAZ-21 DIR',
    	'FAZ-22',
    	'FAZ-22 MF',
    	'FAZ-23',
    	'FAZ-23 CER',
    	'FAZ-23 COM',
    	'FAZ-23 ISS',
    	'FAZ-24',
    	'FAZ-24 FISCAL',
    	'FAZ-24 TAXAS',
    	'FAZ-25',
    	'FAZ-25 DEM',
    	'FAZ-25 DEV',
    	'FAZ-25 FISCAL'
    )
    ORDER BY ES.SGORGAOSETOR ASC, 
             U.NMUSUARIO ASC;

--Busca as unidades/setores por sistema
SELECT
	B.CDORGAOSETOR,
	B.SGORGAOSETOR 
FROM SOLAR.ESEGUSRSETORSIST A
    INNER JOIN SOLAR.ECPAORGAOSETOR B ON A.CDORGAOSETOR = B.CDORGAOSETOR
    INNER JOIN SOLAR.ESEGUSUARIO U ON A.CDUSUARIO = U.CDUSUARIO
WHERE 
    A.CDSISTEMA = 64
    AND B.SGORGAOSETOR IN (
    	'FAZ-11',
    	'FAZ-11 CIP',
    	'FAZ-11 CP',
    	'FAZ-13',
    	'FAZ-13 COM',
    	'FAZ-13 DECI',
    	'FAZ-13 NOT',
    	'FAZ-14',
    	'FAZ-14 AVB',
    	'FAZ-14 CART',
    	'FAZ-14 COM',
    	'FAZ-14 NOT',
    	'FAZ-14 VISTAS',
    	'FAZ-16',
    	'FAZ-16 COM',
    	'FAZ-16 NOT',
    	'FAZ-21',
    	'FAZ-21 DIR',
    	'FAZ-22',
    	'FAZ-22 MF',
    	'FAZ-23',
    	'FAZ-23 CER',
    	'FAZ-23 COM',
    	'FAZ-23 ISS',
    	'FAZ-24',
    	'FAZ-24 FISCAL',
    	'FAZ-24 TAXAS',
    	'FAZ-25',
    	'FAZ-25 DEM',
    	'FAZ-25 DEV',
    	'FAZ-25 FISCAL'
    );

/*Consulta no banco de dados para trazer a relação das unidades/setores e suas unidades/setores pai de um órgão*/
SELECT 
    ESPAI.SGORGAOSETOR AS SGORGAOSETOR_PAI, 
    ESPAI.NMORGAOSETOR AS NMORGAOSETOR_PAI,
    ES.SGORGAOSETOR, 
    ES.NMORGAOSETOR
FROM 
    ECPAORGAOSETOR ES
LEFT JOIN 
    ECPAORGAOSETOR ESPAI ON ES.CDSETORPAI = ESPAI.CDORGAOSETOR
WHERE 
    ES.CDORGAO = (SELECT CDORGAOSETOR FROM ECPAORGAOSETOR WHERE SGORGAOSETOR = 'PMRP')-- orgao
    AND ES.FLSETORATIVO = 'S'
   -- AND ES.SGORGAOSETOR = 'ADM-PCCS ANALISADOS'
ORDER BY 
    ESPAI.SGORGAOSETOR;