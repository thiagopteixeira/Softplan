/*Consulta no banco de dados para trazer a relação dos usuários ativos associados, vinculados as unidades/setores
da Secretária Municipal da Educação de Ribeirão Preto*/
SELECT A.CDUSUARIO, U.NMUSUARIO, B.SGORGAOSETOR, A.FLSETORDEFAULT
FROM SOLAR.ESEGUSRSETORSIST A
JOIN SOLAR.ECPAORGAOSETOR B ON A.CDORGAOSETOR = B.CDORGAOSETOR
JOIN SOLAR.ESEGUSUARIO U ON A.CDUSUARIO = U.CDUSUARIO
WHERE A.CDSISTEMA = 64
AND (B.SGORGAOSETOR LIKE '%EDUC%' OR B.SGORGAOSETOR LIKE '%DIR%')
AND B.FLSETORATIVO = 'S'
ORDER BY A.CDUSUARIO;

/*Consulta no banco de dados para trazer a relação dos usuários ativos associados, vinculados as unidades/setores
da Secretária Municipal da Assistência Social de Ribeirão Preto*/
SELECT A.CDUSUARIO AS Usuário, 
       INITCAP(U.NMUSUARIO) AS Nome_do_Usuário, 
       B.SGORGAOSETOR AS Sigla_da_Unidade_Setor, 
       CASE WHEN A.FLSETORDEFAULT = 'S' THEN 'Sim'
            WHEN A.FLSETORDEFAULT = 'N' THEN 'Não'
            ELSE A.FLSETORDEFAULT 
       END AS Unidade_Setor_Padrão
FROM SOLAR.ESEGUSRSETORSIST A
JOIN SOLAR.ECPAORGAOSETOR B ON A.CDORGAOSETOR = B.CDORGAOSETOR
JOIN SOLAR.ESEGUSUARIO U ON A.CDUSUARIO = U.CDUSUARIO
WHERE A.CDSISTEMA = 64
AND (B.SGORGAOSETOR LIKE '%SEMAS%' OR B.SGORGAOSETOR LIKE '%FRASSOL%' OR B.SGORGAOSETOR LIKE '%PAEFI%' OR B.SGORGAOSETOR LIKE '%MJM%')
AND B.FLSETORATIVO = 'S'
ORDER BY U.NMUSUARIO;

/*Consulta no banco de dados para trazer a relação das unidades/setores do usuário informado*/
SELECT
    A.CDUSUARIO AS Usuário,
    U.NMUSUARIO AS Nome_do_Usuário,
    B.SGORGAOSETOR AS Sigla_da_Unidade_Setor,
    B.NMORGAOSETOR AS Nome_da_Unidade_Setor,
    A.FLSETORDEFAULT AS Unidade_Setor_Padrão
FROM SOLAR.ESEGUSRSETORSIST A
JOIN SOLAR.ECPAORGAOSETOR B ON A.CDORGAOSETOR = B.CDORGAOSETOR
JOIN SOLAR.ESEGUSUARIO U ON A.CDUSUARIO = U.CDUSUARIO
WHERE A.CDSISTEMA = 64
AND A.CDUSUARIO = '36460043809' --ERICK MARZOLA BRESCIANI--
ORDER BY CASE 
            WHEN A.FLSETORDEFAULT = 'S' THEN 1 
            ELSE 2 
         END, 
         B.SGORGAOSETOR;

/*Consulta no banco de dados para trazer a relação das unidades/setores dos usuários informados*/
SELECT
    A.CDUSUARIO AS Usuário,
    U.NMUSUARIO AS Nome_do_Usuário,
    B.SGORGAOSETOR AS Sigla_da_Unidade_Setor,
    B.NMORGAOSETOR AS Nome_da_Unidade_Setor,
    A.FLSETORDEFAULT AS Unidade_Setor_Padrão
FROM SOLAR.ESEGUSRSETORSIST A
JOIN SOLAR.ECPAORGAOSETOR B ON A.CDORGAOSETOR = B.CDORGAOSETOR
JOIN SOLAR.ESEGUSUARIO U ON A.CDUSUARIO = U.CDUSUARIO
WHERE A.CDSISTEMA = 64
AND A.CDUSUARIO IN ('15847451857', '22137204878', '10176837434', '03826151828', '11828913812', '94792275849', '07133809850', '07169722801', '25635264859', '42630362809', '36561600827', '35842603888', '07597154674', '33213552801', '31230848843', '20054331870', '21850503893', '17861618854', '02040330801', '08311233896', '36740366810', '60520370830', '23567998854', '32952242852', '18452471831', '00580409600', '36402237809', '06602663852', '05615008865', '41926198816', '36465833808', '00543393836', '34852510890', '22859071687', '04148534159', '14366966824', '40584056869', '33517753858', '38554774850', '01123849196', '07306985990', '05690075850', '42701375843', '04956531877', '00889170967', '22856813801', '36942433802', '08706230873', '07170720884', '10903566842', '42218307863', '25437512899', '36662545864', '35340368831', '41876430877', '35944526890', '55107192815', '37596048897', '36933423859', '32088198890', '36382716847', '09481262804', '39321965890', '21665647809', '35275646836', '36657642890', '18137072861', '38709827803', '35258494861', '07103396825', '11387239830', '46347070715', '31460709870', '39593667873', '07136818885', '10912031808', '03438987805', '35411798809', '35267785822', '02643885856', '04609965844', '33494842809', '44982682615', '44491475881', '60463155653', '18324283897', '07782827671', '28569905840', '05246934802', '74810316815', '44897465800', '30781727839', '13856519890', '31182235883', '17546857813', '10868401862', '31855183811', '10912654880', '21768299803', '45527190840', '21936999846', '35971841890', '36879121837', '28545672691', '86284312849', '75559048615', '07529411861', '21613691807', '01548457876', '14111867880', '86900005772', '56941781734', '48498750687', '46963450846', '07164358885', '04833339803', '06674170950', '97422290820', '14456040866', '10896932818', '38871432568', '10700255850', '74531492820', '29598000877', '79206298534', '11737837846', '13857756888', '07154492813', '07156033883', '35750753875', '09412800800', '21582595828', '00541159810', '06261393842', '02663078840', '10343422824', '14446257803', '02836348801', '02000919804', '05326751852', '73450545604', '93231601800', '35638050833', '04756888569', '14104043826')
ORDER BY U.NMUSUARIO,
         CASE 
            WHEN A.FLSETORDEFAULT = 'S' THEN 1 
            ELSE 2 
         END, 
         B.SGORGAOSETOR;

--Consulta no banco de dados para trazer a relação dos usuários ativos--
SELECT CDUSUARIO, NMUSUARIO, DTATIVACAO, TPUSUARIO, NUCPFCNPJ, FLHABILITADO, DEEMAIL, DTULTLOGINOK, TPPESSOA
FROM SOLAR.ESEGUSUARIO WHERE FLHABILITADO = 'S' ORDER BY NMUSUARIO;


--Busca todos os usuários ativos em setores ativos, retirando portal e buscando por orgao--
SELECT 
    A.CDUSUARIO, 
    U.NMUSUARIO, 
    B.SGORGAOSETOR, 
    B.NMORGAOSETOR ,
    B.FLSETORATIVO ,
    A.FLSETORDEFAULT
FROM 
    SOLAR.ESEGUSRSETORSIST A
    INNER JOIN SOLAR.ECPAORGAOSETOR B ON A.CDORGAOSETOR = B.CDORGAOSETOR
    INNER JOIN SOLAR.ESEGUSUARIO U ON A.CDUSUARIO = U.CDUSUARIO
WHERE 
    A.CDSISTEMA = 64
    AND B.FLSETORATIVO = 'S'
    AND U.FLHABILITADO = 'S'
    AND B.CDORGAOSETOR != 18
    AND B.CDORGAO = 1 -- PMRP
ORDER BY 
    A.CDUSUARIO;


--Busca todos os usuários ativos (sem duplicidade) em setores ativos, retirando portal e buscando por orgao--
SELECT 
    COUNT(DISTINCT A.CDUSUARIO) AS TOTAL_USUARIOS_ATIVOS
FROM 
    SOLAR.ESEGUSRSETORSIST A
    INNER JOIN SOLAR.ECPAORGAOSETOR B ON A.CDORGAOSETOR = B.CDORGAOSETOR
    INNER JOIN SOLAR.ESEGUSUARIO U ON A.CDUSUARIO = U.CDUSUARIO
WHERE 
    A.CDSISTEMA = 64
    AND B.FLSETORATIVO = 'S'
    AND U.FLHABILITADO = 'S'
    AND B.CDORGAOSETOR != 18
    AND B.CDORGAO = 1 -- PMRP

--Busca todos os usuários ativos (sem duplicidade) no setor "PORTAL" (PORTAL) e buscando por orgao--
SELECT 
    COUNT(DISTINCT A.CDUSUARIO) AS TOTAL_USUARIOS_ATIVOS
FROM 
    SOLAR.ESEGUSRSETORSIST A
    INNER JOIN SOLAR.ECPAORGAOSETOR B ON A.CDORGAOSETOR = B.CDORGAOSETOR
    INNER JOIN SOLAR.ESEGUSUARIO U ON A.CDUSUARIO = U.CDUSUARIO
WHERE 
    A.CDSISTEMA = 64
    AND B.FLSETORATIVO = 'S'
    AND U.FLHABILITADO = 'S'
    AND B.CDORGAOSETOR = 18
    AND B.CDORGAO = 1 -- PMRP

--Busca o total de usuários ativos (sem duplicidade) em setores ativos, separando o total de usuários do portal interno e portal externo ("PORTAL" (PORTAL)), buscando por orgao e somando o total de usuários do portal internon + portal externo--
SELECT 
    COUNT(DISTINCT CASE WHEN B.CDORGAOSETOR != 18 THEN A.CDUSUARIO END) AS TOTAL_DE_USUARIOS_ATIVOS_DO_PORTAL_INTERNO,
    COUNT(DISTINCT CASE WHEN B.CDORGAOSETOR = 18 THEN A.CDUSUARIO END) AS TOTAL_DE_USUARIOS_ATIVOS_DO_PORTAL_EXTERNO,
    COUNT(DISTINCT CASE WHEN B.CDORGAOSETOR != 18 THEN A.CDUSUARIO END) + 
    COUNT(DISTINCT CASE WHEN B.CDORGAOSETOR = 18 THEN A.CDUSUARIO END) AS TOTAL_GERAL
FROM 
    SOLAR.ESEGUSRSETORSIST A
    INNER JOIN SOLAR.ECPAORGAOSETOR B ON A.CDORGAOSETOR = B.CDORGAOSETOR
    INNER JOIN SOLAR.ESEGUSUARIO U ON A.CDUSUARIO = U.CDUSUARIO
WHERE 
    A.CDSISTEMA = 64
    AND B.FLSETORATIVO = 'S'
    AND U.FLHABILITADO = 'S'
    AND B.CDORGAO = 1 -- PMRP


/*Consulta no banco de dados para trazer a relação das unidades/setores e suas unidades/setores pai de um órgão*/
SELECT 
    ESPAI.SGORGAOSETOR AS SGORGAOSETOR_PAI, 
    ESPAI.NMORGAOSETOR AS NMORGAOSETOR_PAI,
    ES.SGORGAOSETOR, 
    ES.NMORGAOSETOR
FROM 
    ECPAORGAOSETOR ES
LEFT JOIN 
    ECPAORGAOSETOR ESPAI ON ES.CDSETORPAI = ESPAI.CDORGAOSETOR
WHERE 
    ES.CDORGAO = (SELECT CDORGAOSETOR FROM ECPAORGAOSETOR WHERE SGORGAOSETOR = 'PMRP')-- orgao
    AND ES.FLSETORATIVO = 'S'
   -- AND ES.SGORGAOSETOR = 'ADM-PCCS ANALISADOS'
ORDER BY 
    ESPAI.SGORGAOSETOR;